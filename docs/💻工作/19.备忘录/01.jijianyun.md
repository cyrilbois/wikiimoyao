---
title: 开发记录文档
date: 2022-04-24 17:18:25
permalink: /pages/62e572/
categories:
  - 工作
  - 备忘录
tags:
  - 记录
article: false
---

## 代码模式配置

### 应用占位

对`app_id`占用

### 动作占位

以上操作需要在编辑成功后手动复制到表中

```sql
SELECT * FROM app_action_meta WHERE app_id = 264
```

修改 `is_end=0`（不可作为截止动作）,`request_type=POST`（默认都为 post）

## 执行动作

### 在 init 中

account_check/connection_config 中
id 为应用 id
match_field
id 为动作 id

### SampleData

触发动作需要实现
如何添加？
规则是什么？

## 触发动作

对于有字段需要用户填写的触发动作，需要手动修改`additional=1`，这样才能渲染出输入框

### 测试上线

1. 申请测试数据库写入数据
2. 申请安装包
3. 提交代码到自己的开发分支
4. 如果有第三方依赖，申请安装依赖
5. 到 developer 分支合并修改的代码并提交
6. 进入开发配置平台发布上测试申请（自行上线测试）
7. 进入测试环境自测

### 生产上线

1. 切换 master 分支 pull 最新的代码
2. 切换到工作分支，合并 master 最新代码，如果有 conflict 则解决之
3. 提交代码到远程工作分支
4. 代码管理-合并请求-将工作分支合并到 master 分支
5. 将开发数据库中的 sql 提交生产数据库中的审批工单（可以去测试上面复制）
6. 等待代码合并通过
7. 等待数据库审批通过后去开发者平台提交生产上线申请，其中备注栏可以填写安装依赖的信息
8. 等待审批通过并执行
9. 等待审批通过，完成上线

## 开发者平台

### oauth2 流程

1. 去平台申请`client_id` 和`client_secret`
2. 配置授权回调地址
3. 代表用户获取访问权限请求授权地址`authorize`返回 code
4. 拼接请求地址，拉起访问授权页面
5. 获取令牌，访问`token`页面，此时响应如下：

    ```json
    {
        "token_type": "Bearer",
        "scope": "user.read%20Fmail.read",
        "expires_in": 3600,
        "access_token": "eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsIng1dCI6Ik5HVEZ2ZEstZnl0aEV1Q...",
        "refresh_token": "AwABAAAAvPM1KaPlrEqdFSBzjqfTGAMxZGUTdM0t4B4..."
    }
    ```

6. 利用 access_token 可以访问接口
7. 利用 refresh_token 可以刷新 token

```json
{
    "token_type": "Bearer",
    "scope": "Notes.Create Notes.Read Notes.ReadWrite email profile Notes.Read.All Notes.ReadWrite.All",
    "expires_in": 3600,
    "ext_expires_in": 3600,
    "access_token": "EwBwA8l6BAAUkj1...4obR6Ag==",
    "refresh_token": "M.R3_BAY.-CZVsfCyzxlGjk1Uy0GJXCnA6bh7WFTguj5rG7G3mZjXT...v6RZi*5mcjTQw$$"
}
```

### 对于 group 字段的编写

参考应用“聚水潭”执行动作——新建盘点单：

- 配置内字典列表的字段时：选择“动作字段设置”——字段组

- 配置列表套列表的数据类型
  
  ```python
  
    outPutData = [
        {
            "key": "data",
            "label": "xxx",
            "type": "group",
            "items": [
                {
                    "key": "so_id"，
                    "label":"外部单号",
                    "type": "string",
                    "required": True
                }, {
                    "key": "warehouse"，
                    "label":"仓库",
                    "required": True,
                "multiples": False,
                "type": "number",
                "dropdown": True,
                "choices": [
                                {
                                "key": 1,
                                "label": "主仓"
                                },
                                {
                                "key": 2,
                                "label": "销退仓"
                                },
                                {
                                "key": 3,
                                "label": "进货仓"
                                },
                                {
                                "key": 4,
                                "label": "次品仓"
                                }
                            ]
                            },
                    {
                    "key": "remark"，
                    "label":"备注",
                    "type": "string",
                    "required": False
                },
                {
                    "key": "items",
                    "label": "商品明细",
                    "type": "group",
                    "help_txt":"最大50",
                    "items": [
                    {
                    "key": "sku_id"，
                    "label":"商品编码",
                    "type": "string",
                    "required": True
                },{
                    "key": "qty"，
                    "label":"数量",
                    "type": "number",
                    "required": True
                },{
                    "key": "batch_id"，
                    "label":"批次号",
                    "type": "string",
                    "help_txt":"批次号存在批次信息和有效期必填",
                    "required": False
                },{
                    "key": "produced_date"，
                    "label":"批次日期",
                    "type": "string",
                    "help_txt":"时间戳；示例1644822870",
                    "required": False
                },{
                    "key": "expiration_date"，
                    "label":"有效期",
                    "type": "string",
                    "help_txt":"时间戳；示例1644822870",
                    "required": False
                },
                ]
                }
            ]
        }
    ]

    ```

## token

### tushare

```bash
4c562465125a1b5822095898168cd21a8870bac2dbbee0ed24fce68f
d95ea8510cd48dcaf50422b0fa4e7312643245ba731fbd308f084385
db42fb5372bce72ab61f22ef0a3310d5c441f09d17817f1cafd3ace2
b280312f2903dbec185c07535e9ab3f67df9bfe2220e08e46742b9b5
e53a32fc435f5fc25ab450333bda9d545856f1dfa1afc3d11699edcc
```

## 其他

### 部署上线

spug

## 依赖

```plain
addressnormalize @ file:///D:/python/project/django/address_normalize-main/dist/addressnormalize-1.2.0.tar.gz
aftership==1.3.0
aiohttp==3.8.1
aiosignal==1.2.0
alibabacloud-address-purification20191118==1.0.1
alibabacloud-credentials==0.2.0
alibabacloud-dingtalk==1.2.38
alibabacloud-endpoint-util==0.0.3
alibabacloud-gateway-spi==0.0.1
alibabacloud-ocr-api20210707==1.1.4
alibabacloud-openapi-util==0.1.6
alibabacloud-tea==0.2.8
alibabacloud-tea-openapi==0.3.1
alibabacloud-tea-util==0.3.5
aliyun-python-sdk-core==2.13.36
aliyun-python-sdk-imagerecog==1.0.17
aliyun-python-sdk-kms==2.15.0
aliyun-python-sdk-qualitycheck==3.0.1
APScheduler==3.9.1
asgiref==3.5.0
async-timeout==4.0.2
asynctest==0.13.0
attrs==21.4.0
authing==4.5.16
backports.zoneinfo==0.2.1
baidu-aip==4.16.2
bcrypt==3.1.7
beautifulsoup4==4.10.0
boltons==21.0.0
boto3==1.21.34
botocore==1.24.34
bracex==2.2.1
bs4==0.0.1
casbin==1.15.4
casbin-sqlalchemy-adapter==0.4.2
certifi==2019.9.11
cffi==1.13.2
chardet==3.0.4
charset-normalizer==2.0.12
cn2an==0.5.16
coreapi==2.3.1
coreschema==0.0.4
crcmod==1.7
cryptography==36.0.2
decorator==5.1.1
demjson==1.6
Deprecated==1.2.13
Django==3.2.12
django-cors-headers==3.1.1
django-redis==5.2.0
djangorestframework==3.13.1
djangorestframework-jwt==1.11.0
dynaconf==3.1.4
emoji==1.7.0
environs==9.5.0
fabric==2.5.0
Faker==13.3.4
feedparser==6.0.8
ffmpeg==1.4
flatten-json==0.1.7
formulas==1.2.2
frozenlist==1.3.0
google==3.0.0
gql==2.0.0
graphql-core==2.3.2
greenlet==1.1.2
gunicorn==19.9.0
hanlp-downloader==0.0.25
hotxlfp==0.0.15
html2text==2020.1.16
httplib2==0.20.4
idna==2.8
importlib-metadata==2.1.3
install==1.3.5
invoke==1.3.0
isodatetimehandler==1.0.2
itypes==1.1.0
Jinja2==2.10.3
jmespath==0.9.5
JPype1==0.7.0
jsonpath==0.82
jsonpickle==2.1.0
lxml==4.8.0
Markdown==3.3.4
MarkupSafe==1.1.1
marshmallow==3.15.0
moesifapi==1.3.3
moesifdjango==2.0.5
moesifpythonrequest==0.2.0
multidict==6.0.2
nose==1.3.7
numpy==1.21.5
numpy-financial==1.0.0
O365==2.0.18.1
oauth2==1.9.0.post1
oauthlib==3.2.0
oss2==2.15.0
packaging==21.3
pandas==1.3.5
paramiko==2.6.0
phone==0.4.3
phonenumbers==8.12.46
pika==1.2.0
Pillow==9.0.1
ply==3.11
postal-address==1.4.1
proces==0.1.2
promise==2.3
protobuf==3.20.0
psycopg2==2.9.3
py==1.11.0
pyactiveresource==2.2.2
pyasn1==0.4.8
pycountry==18.5.26
pycparser==2.19
pycryptodome==3.14.1
pydantic==1.9.0
pyhanlp==0.1.84
PyJWT==1.7.1
pymongo==4.1.0
PyMySQL==1.0.2
PyNaCl==1.3.0
pyodbc==4.0.30
pyparsing==3.0.7
python-dateutil==2.8.1
python-dotenv==0.20.0
pytz==2019.3
pytz-deprecation-shim==0.1.0.post0
PyYAML==6.0
redis==3.3.11
regex==2022.3.15
requests==2.27.1
requests-oauthlib==1.3.1
requests-toolbelt==0.9.1
retry==0.9.2
rsa==4.0
ruamel.yaml==0.17.21
ruamel.yaml.clib==0.2.6
Rx==1.6.1
s3transfer==0.5.2
schedula==1.2.14
sentry-sdk==1.5.6
sgmllib3k==1.0.0
ShopifyAPI==11.0.0
simpleeval==0.9.12
simplejson==3.17.6
six==1.13.0
soupsieve==2.3.1
SQLAlchemy==1.4.34
sqlparse==0.4.2
stringcase==1.2.0
suds==1.0.0
tencentcloud-sdk-python==3.0.612
thrift==0.13.0
tushare==1.2.84
typing_extensions==4.1.1
tzdata==2022.1
tzlocal==4.2
uritemplate==3.0.0
urllib3==1.25.6
vika==1.0.9
volcengine==1.0.34
wcmatch==8.3
websocket-client==0.57.0
wincertstore==0.2
wrapt==1.14.0
xlrd==1.2.0
xmltodict==0.12.0
yarl==1.7.2
zhconv==1.4.3
zipp==3.8.0
```

## 迁移脚本

- 迁移大数据量时耗时

以下是几个常见的优化方式：

1. 缓存数据：避免无必要的数据库访问，可以提高执行效率。对于读取频繁的数据，可以设置缓存，减少数据库访问次数。缓存可以使用 Redis、Memcached 等工具来实现。

2. 批量操作：使用批量操作可以减少频繁的数据库访问操作，从而提高执行效率。例如，使用批量插入、批量更新、批量删除等方式。

3. 数据库连接池：连接池是一种常见的优化方式，可以减少创建和销毁连接的开销，提高数据库的访问效率。连接池管理数据库连接的创建和销毁，每次访问数据库时，从连接池中获取连接，当访问结束后，将连接归还到连接池中。

4. 优化 SQL 语句：通过优化 SQL 语句，可以减少对数据库的访问次数，提高执行效率。其中一些优化技巧包括：避免 SELECT *，尽量使用索引，避免使用子查询，使用 JOIN 替代子查询等。

5. 数据库分片：对于数据量较大的数据库，可以将数据划分成多个分片，从而实现并行处理，提高执行效率。数据库分片可以根据业务需求来设定，例如按照时间、地理位置或者用户 ID 等进行分片。

以上是常见的一些优化方式，综合使用这些方法可以极大地提高数据库的执行效率和减少耗时。

### 实践

- 创建：
1. 数据库使用连接池，创建时间减少 30%
- 回滚：
0. 初始为 14 秒
1. redis 缓存查询的数据。时间减少 30%，到 8 秒
2. 批量提交，再减少 50%，到 6 秒
3. 线程池（3s）

创建 15-11，删除 14-8.4 ——7.5 -6-3


## 订单处理

### 超时订单如何处理

redis 自动过期的实现方式是：定时任务离线扫描并删除部分过期键；在访问键时惰性检查是否过期并删除过期键。redis 从未保证会在设定的过期时间立即删除并发送过期通知。实际上，过期通知晚于设定的过期时间数分钟的情况也比较常见。
此外键空间通知采用的是发送即忘(fire and forget)策略，并不像消息队列一样保证送达。当订阅事件的客户端会丢失所有在断线期间所有分发给它的事件。

[订单支付超时未支付关闭订单的解决方案 - 掘金](https://juejin.cn/post/6996088295612481572)

[领导：谁再用 redis 过期监听实现关闭订单，立马滚蛋！ - 掘金](https://juejin.cn/post/7108351216425386014)

勘误：[Redisson 延时队列原理详解 - 知乎](https://zhuanlan.zhihu.com/p/343811173)